```sql
WITH ETL_WT AS (
  SELECT TRUNC(TO_DATE('20210101')) AS ETL_START_AT
    , TRUNC(TO_DATE('20210102')) AS ETL_END_AT
    ,'20210101' AS ETL_START_DT
    ,'20210102' AS ETL_END_DT
  FROM DUAL
), PAYMENT_UNIFY_ORDER AS (
    select 'ON' AS ONOFF_TYPE
    , O.PAYMENT_ONLINE_ORDER_ID AS PAYMENT_ORDER_ID
    , O.ONLINE_ITEM_ID AS ITEM_ID
    , O.PAYMENT_METHOD, O.AMOUNT, O.PAYMENT_USER_ID, O.STATUS
    , TO_CHAR(O.CREATED_AT, 'YYYYMMDD') AS CREATE_DT
    , TO_CHAR(O.UPDATED_AT, 'YYYYMMDD') AS UPDATED_DT 
    from PAYMENT.PAYMENT_ONLINE_ORDER O
    union all
    select 'OFF' AS ONOFF_TYPE
    , F.PAYMENT_OFFLINE_ORDER_ID AS PAYMENT_ORDER_ID
    , F.OFFLINE_ITEM_ID AS ITEM_ID
    , F.PAYMENT_METHOD, F.AMOUNT, F.PAYMENT_USER_ID, F.STATUS
    , TO_CHAR(F.CREATED_AT, 'YYYYMMDD') AS CREATE_DT
    , TO_CHAR(F.UPDATED_AT, 'YYYYMMDD') AS UPDATED_DT 
    from PAYMENT.PAYMENT_OFFLINE_ORDER F
), PAYMENT_UNIFY_ITEM AS (
    SELECT 'ON' AS ONOFF_TYPE, O.ONLINE_ITEM_ID AS ITEM_ID, O.MERCHANT_NAME
    FROM PAYMENT.ONLINE_ITEM O
    UNION ALL 
    SELECT 'OFF' AS ONOFF_TYPE, F.OFFLINE_ITEM_ID AS ITEM_ID, F.MERCHANT_NAME
    FROM PAYMENT.OFFLINE_ITEM F
), UNIFY_USERS AS (
    select  a.KAKAOPAY_USER_ID            -- 카카오페이고객유니크ID
      , DECODE(A.GENDER, 'FEMALE', '여자', 'MALE', '남자', '알수없음')          AS GENDER
      , a.BIRTHDAY        AS BIRTHDAY                        -- 성별
      , a.DEVICE          AS DEVICE                          -- 디바이스종류
      , a.STATUS          AS USER_STATUS                     -- 카카오페이고객계정상태값
      , A.CREATED_AT      AS USER_CREATED_AT                 -- 카카오페이가입일시
      , CASE A.STATUS WHEN '탈퇴' THEN A.UPDATED_AT END AS EXITED_AT --카카오페이탈퇴일시
      , M.MONEY_USER_ID                   --카카오페이머니사용고객유니크ID
      , P.PAYMENT_USER_ID                 --카카오페이결제사용고객유니크ID
      , M.STATUS          AS MONEY_USER_STATUS
      , TO_CHAR(M.CREATED_AT, 'YYYYMMDD') AS MONEY_USER_CREATED_DT  --머니고객가입일자
      , CASE M.STATUS WHEN '탈퇴' THEN TO_CHAR(M.UPDATED_AT, 'YYYYMMDD') END AS MONEY_USER_EXITED_DT --머니고객탈퇴일자
      , P.STATUS AS PAY_USER_STATUS --페이결제고객상태
      , TO_CHAR(P.CREATED_AT, 'YYYYMMDD') AS PAY_USER_CREATE_DT --페이고객가입일자
      , CASE P.STATUS WHEN '탈퇴' THEN TO_CHAR(P.UPDATED_AT, 'YYYYMMDD') END as PAY_USER_EXITED_DT --페이고객탈퇴일자
    from ACCOUNT.KAKAOPAY_USER a, MONEY.MONEY_USER m, PAYMENT.PAYMENT_USER p
    where 1=1
    and a.kakaopay_user_id = M.KAKAOPAY_USER_ID(+)
    and a.kakaopay_user_id = P.KAKAOPAY_USER_ID(+)
), RATE AS (
  SELECT R.COMM_DT, R.ONOFF_TYPE, R.RATE 
  FROM PAYMENT.COMM_RATE R
  WHERE R.COMM_DT = '20210101'
)
  
select DISTINCT PAYMENT_UNIFY_ORDER.UPDATED_DT AS 거래날짜
  , UNIFY_USERS.GENDER
  , PAYMENT_UNIFY_ITEM.MERCHANT_NAME AS 결제처별
  , COUNT(DISTINCT UNIFY_USERS.KAKAOPAY_USER_ID) OVER(PARTITION BY PAYMENT_UNIFY_ORDER.UPDATED_DT, UNIFY_USERS.GENDER, PAYMENT_UNIFY_ITEM.MERCHANT_NAME) AS 결제고객수
  , SUM(CASE PAYMENT_UNIFY_ORDER.STATUS WHEN 'PAYMENT' THEN 1 ELSE 0 END) OVER(PARTITION BY PAYMENT_UNIFY_ORDER.UPDATED_DT, UNIFY_USERS.GENDER, PAYMENT_UNIFY_ITEM.MERCHANT_NAME)
    - SUM(CASE PAYMENT_UNIFY_ORDER.STATUS WHEN 'CANCEL' THEN 1 ELSE 0 END) OVER(PARTITION BY PAYMENT_UNIFY_ORDER.UPDATED_DT, UNIFY_USERS.GENDER, PAYMENT_UNIFY_ITEM.MERCHANT_NAME) AS 결제총건수
  , SUM(CASE PAYMENT_UNIFY_ORDER.STATUS WHEN 'PAYMENT' THEN PAYMENT_UNIFY_ORDER.AMOUNT ELSE 0 END) OVER(PARTITION BY PAYMENT_UNIFY_ORDER.UPDATED_DT, UNIFY_USERS.GENDER, PAYMENT_UNIFY_ITEM.MERCHANT_NAME)
    - SUM(CASE PAYMENT_UNIFY_ORDER.STATUS WHEN 'CANCEL' THEN PAYMENT_UNIFY_ORDER.AMOUNT ELSE 0 END) OVER(PARTITION BY PAYMENT_UNIFY_ORDER.UPDATED_DT, UNIFY_USERS.GENDER, PAYMENT_UNIFY_ITEM.MERCHANT_NAME) AS 결제총금액
--  , RATE.ONOFF_TYPE, RATE.RATE
  , (SUM(CASE PAYMENT_UNIFY_ORDER.STATUS WHEN 'PAYMENT' THEN PAYMENT_UNIFY_ORDER.AMOUNT ELSE 0 END) OVER(PARTITION BY PAYMENT_UNIFY_ORDER.UPDATED_DT, UNIFY_USERS.GENDER, PAYMENT_UNIFY_ITEM.MERCHANT_NAME)
    - SUM(CASE PAYMENT_UNIFY_ORDER.STATUS WHEN 'CANCEL' THEN PAYMENT_UNIFY_ORDER.AMOUNT ELSE 0 END) OVER(PARTITION BY PAYMENT_UNIFY_ORDER.UPDATED_DT, UNIFY_USERS.GENDER, PAYMENT_UNIFY_ITEM.MERCHANT_NAME)
    )*  RATE.RATE / 100 AS 수수료합계
from PAYMENT_UNIFY_ORDER PAYMENT_UNIFY_ORDER
    , UNIFY_USERS UNIFY_USERS
    , PAYMENT_UNIFY_ITEM PAYMENT_UNIFY_ITEM
    , ETL_WT ETL_WT
    , RATE
where 1=1
AND PAYMENT_UNIFY_ORDER.PAYMENT_USER_ID = UNIFY_USERS.PAYMENT_USER_ID(+)
AND PAYMENT_UNIFY_ORDER.ITEM_ID = PAYMENT_UNIFY_ITEM.ITEM_ID(+)
AND PAYMENT_UNIFY_ORDER.ONOFF_TYPE = PAYMENT_UNIFY_ITEM.ONOFF_TYPE
AND RATE.COMM_DT = PAYMENT_UNIFY_ORDER.UPDATED_DT
AND RATE.ONOFF_TYPE = PAYMENT_UNIFY_ORDER.ONOFF_TYPE
AND PAYMENT_UNIFY_ORDER.UPDATED_DT >= ETL_WT.ETL_START_DT AND PAYMENT_UNIFY_ORDER.UPDATED_DT < ETL_WT.ETL_END_DT
ORDER BY 1,2,3;


```