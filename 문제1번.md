``` sql
WITH ETL_WT AS (                                        /* 일별 보고서 추출 가정*/
    SELECT TRUNC(SYSDATE-1) AS ETL_START_AT
      , TRUNC(SYSDATE) AS ETL_END_AT
      , TO_CHAR(SYSDATE-1, 'YYYYMMDD') AS ETL_START_DT
      , TO_CHAR(SYSDATE, 'YYYYMMDD') AS ETL_END_DT
    FROM DUAL 
), PAYMENT_UNIFY_ORDER AS (             /* 카카오페이 결제 온/오프 통합테이블 가정 */
    SELECT 'ON' AS ONOFF_TYPE
    , O.PAYMENT_ONLINE_ORDER_ID AS PAYMENT_ORDER_ID
    , O.ONLINE_ITEM_ID AS ITEM_ID
    , O.PAYMENT_METHOD, O.AMOUNT, O.PAYMENT_USER_ID, O.STATUS
    , TO_CHAR(O.CREATED_AT, 'YYYYMMDD') AS CREATE_DT
    , TO_CHAR(O.UPDATED_AT, 'YYYYMMDD') AS UPDATED_DT 
    FROM PAYMENT.PAYMENT_ONLINE_ORDER O
    UNION ALL
    SELECT 'OFF' AS ONOFF_TYPE
    , F.PAYMENT_OFFLINE_ORDER_ID AS PAYMENT_ORDER_ID
    , F.OFFLINE_ITEM_ID AS ITEM_ID
    , F.PAYMENT_METHOD, F.AMOUNT, F.PAYMENT_USER_ID, F.STATUS
    , TO_CHAR(F.CREATED_AT, 'YYYYMMDD') AS CREATE_DT
    , TO_CHAR(F.UPDATED_AT, 'YYYYMMDD') AS UPDATED_DT 
    FROM PAYMENT.PAYMENT_OFFLINE_ORDER F
), PAYMENT_UNIFY_ITEM AS (
    SELECT 'ON' AS ONOFF_TYPE, O.ONLINE_ITEM_ID AS ITEM_ID, O.MERCHANT_NAME
    FROM PAYMENT.ONLINE_ITEM O
    UNION ALL 
    SELECT 'OFF' AS ONOFF_TYPE, F.OFFLINE_ITEM_ID AS ITEM_ID, F.MERCHANT_NAME
    FROM PAYMENT.OFFLINE_ITEM F
), UNIFY_USERS AS (                             /* 카카오페이 통합고객 테이블 가정*/
    SELECT  A.KAKAOPAY_USER_ID
      , DECODE(A.GENDER, 'FEMALE', '여자', 'MALE', '남자', '알수없음') AS GENDER
      , A.BIRTHDAY        AS BIRTHDAY 
      , A.DEVICE          AS DEVICE
      , A.STATUS          AS USER_STATUS
      , A.CREATED_AT      AS USER_CREATED_AT
      , CASE A.STATUS WHEN '탈퇴' THEN A.UPDATED_AT END AS EXITED_AT
      , M.MONEY_USER_ID
      , P.PAYMENT_USER_ID
      , M.STATUS          AS MONEY_USER_STATUS
      , TO_CHAR(M.CREATED_AT, 'YYYYMMDD') AS MONEY_USER_CREATED_DT
      , CASE M.STATUS WHEN '탈퇴' THEN TO_CHAR(M.UPDATED_AT, 'YYYYMMDD') END AS MONEY_USER_EXITED_DT
      , P.STATUS AS PAY_USER_STATUS
      , TO_CHAR(P.CREATED_AT, 'YYYYMMDD') AS PAY_USER_CREATE_DT
      , CASE P.STATUS WHEN '탈퇴' THEN TO_CHAR(P.UPDATED_AT, 'YYYYMMDD') END AS PAY_USER_EXITED_DT
    FROM ACCOUNT.KAKAOPAY_USER A, MONEY.MONEY_USER M, PAYMENT.PAYMENT_USER P
    WHERE 1=1
    AND A.KAKAOPAY_USER_ID = M.KAKAOPAY_USER_ID
    AND A.KAKAOPAY_USER_ID = P.KAKAOPAY_USER_ID
), RATE AS (                            /* 일별 온/오프 결제처 수수료율 테이블 가정*/
  SELECT R.COMM_DT, R.ONOFF_TYPE, R.RATE 
  FROM PAYMENT.COMM_RATE R
  WHERE R.COMM_DT = 'SYSDATE-1'
)
  
SELECT DISTINCT PAYMENT_UNIFY_ORDER.UPDATED_DT AS "거래날짜"
  , UNIFY_USERS.GENDER AS "성별"
  , PAYMENT_UNIFY_ITEM.MERCHANT_NAME AS "결제처별"
  , COUNT(DISTINCT UNIFY_USERS.KAKAOPAY_USER_ID) OVER(
          PARTITION BY PAYMENT_UNIFY_ORDER.UPDATED_DT, UNIFY_USERS.GENDER, PAYMENT_UNIFY_ITEM.MERCHANT_NAME) AS "결제고객수"
  , SUM(CASE PAYMENT_UNIFY_ORDER.STATUS WHEN 'PAYMENT' THEN 1 ELSE 0 END) OVER(PARTITION BY PAYMENT_UNIFY_ORDER.UPDATED_DT, UNIFY_USERS.GENDER, PAYMENT_UNIFY_ITEM.MERCHANT_NAME)
    - SUM(CASE PAYMENT_UNIFY_ORDER.STATUS WHEN 'CANCEL' THEN 1 ELSE 0 END) OVER(PARTITION BY PAYMENT_UNIFY_ORDER.UPDATED_DT, UNIFY_USERS.GENDER, PAYMENT_UNIFY_ITEM.MERCHANT_NAME) AS "결제총건수"
  , SUM(CASE PAYMENT_UNIFY_ORDER.STATUS WHEN 'PAYMENT' THEN PAYMENT_UNIFY_ORDER.AMOUNT ELSE 0 END) OVER(PARTITION BY PAYMENT_UNIFY_ORDER.UPDATED_DT, UNIFY_USERS.GENDER, PAYMENT_UNIFY_ITEM.MERCHANT_NAME)
    - SUM(CASE PAYMENT_UNIFY_ORDER.STATUS WHEN 'CANCEL' THEN PAYMENT_UNIFY_ORDER.AMOUNT ELSE 0 END) OVER(PARTITION BY PAYMENT_UNIFY_ORDER.UPDATED_DT, UNIFY_USERS.GENDER, PAYMENT_UNIFY_ITEM.MERCHANT_NAME) AS "결제총금액"
  , (SUM(CASE PAYMENT_UNIFY_ORDER.STATUS WHEN 'PAYMENT' THEN PAYMENT_UNIFY_ORDER.AMOUNT ELSE 0 END) OVER(PARTITION BY PAYMENT_UNIFY_ORDER.UPDATED_DT, UNIFY_USERS.GENDER, PAYMENT_UNIFY_ITEM.MERCHANT_NAME)
    - SUM(CASE PAYMENT_UNIFY_ORDER.STATUS WHEN 'CANCEL' THEN PAYMENT_UNIFY_ORDER.AMOUNT ELSE 0 END) OVER(PARTITION BY PAYMENT_UNIFY_ORDER.UPDATED_DT, UNIFY_USERS.GENDER, PAYMENT_UNIFY_ITEM.MERCHANT_NAME)
    )*  RATE.RATE / 100 AS "수수료합계"
FROM PAYMENT_UNIFY_ORDER PAYMENT_UNIFY_ORDER /* 카카오페이 통합결제 테이블 */
    , UNIFY_USERS UNIFY_USERS                /* 카카오페이 통합고객 테이블*/
    , PAYMENT_UNIFY_ITEM PAYMENT_UNIFY_ITEM  /* 결제 통합상품 테이블 */
    , ETL_WT ETL_WT                          /* 데이터추출기간 */
    , RATE                                   /* 거래처 수수료 테이블 */
WHERE 1=1
AND PAYMENT_UNIFY_ORDER.PAYMENT_USER_ID = UNIFY_USERS.PAYMENT_USER_ID
AND PAYMENT_UNIFY_ORDER.ITEM_ID = PAYMENT_UNIFY_ITEM.ITEM_ID
AND PAYMENT_UNIFY_ORDER.ONOFF_TYPE = PAYMENT_UNIFY_ITEM.ONOFF_TYPE
AND RATE.COMM_DT = PAYMENT_UNIFY_ORDER.UPDATED_DT
AND RATE.ONOFF_TYPE = PAYMENT_UNIFY_ORDER.ONOFF_TYPE
AND PAYMENT_UNIFY_ORDER.UPDATED_DT >= ETL_WT.ETL_START_DT AND PAYMENT_UNIFY_ORDER.UPDATED_DT < ETL_WT.ETL_END_DT
ORDER BY 1,2,3;
```